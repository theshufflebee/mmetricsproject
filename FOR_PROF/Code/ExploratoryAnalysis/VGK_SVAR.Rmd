---
title: "VGK SVAR Models"
output:
  pdf_document: 
    toc: true
    fig_caption: yes
    latex_engine: lualatex
header-includes:
  - \usepackage{amsmath}
---
\newpage

# Setup

## Load packages & functions

```{r library_setup, results=FALSE, warning=FALSE, message=FALSE}
rm(list=ls())
require(tinytex) #LaTeX
require(ggplot2) #plots
require(AEC) #JP-Renne functions
require(AER) #NW formula
require(forecast) #time series stuff
require(expm) #matrix exponents
require(here) #directory finder
require(stringr) # analysis of strings, important for the detection in tweets
require(dplyr) #data management
require(lubridate) #data dates management
require(zoo) #for lagging
require(jtools) #tables
require(huxtable) #tables
require(lmtest) #reg tests
require(vroom) #for loading data
require(data.table) #for data filtering
require(sysid) #for ARMA-X modeling
require(sandwhich) #regression errors
require(stargazer) #nice reg tables
require(tidytext) #text mining
require(textstem) #lemmatization
require(quanteda) #tokenization
require(texreg) #arima tables
require(vars) #VAR models
require(xts) #time series objects
require(tseries) #includes adf test
require(quantmod)
require(TSA)
require(aTSA)
require(tibble)
require(FinTS)
require(kableExtra)
require(writexl)
require(purrr)

getwd()
#setwd("...") -> set wd at base repo folder

#load helper functions
source(here("helperfunctions/data_loaders.R"))
source(here("helperfunctions/date_selector.R"))
source(here("helperfunctions/plotters.R"))
source(here("helperfunctions/quick_arma.R"))
source(here("helperfunctions/r.vol_calculators.R"))
source(here("helperfunctions/truths_cleaning_function.R"))
source(here("helperfunctions/armax_functions.R"))
source(here("helperfunctions/var_irf.R"))

```


## Load Data


```{r datasetup, results=FALSE, warning=FALSE, message=FALSE}

#load final dataset
source(here("helperfunctions/full_data.R"))

#select timeframe 
Vdata = filter(data,between(timestamp, as.Date('2014-01-01'), as.Date('2025-05-07')))
```



# Some SVAR estimations

Note that this is not an exhaustive list of our VAR estimations, you can find 
more by going on /modeling/VAR/VAR_SPY_TRUE or VAR_ASHR_TRUE or VAR_VGK_TRUE).

## Dummy variable 

Here we use a dummy variable which equal to one if Trump has made a post or 0 otherwise, taking into account the closed hour market posts.

```{r Estime dummy, warning=FALSE, message=FALSE, results="asis"}
y = cbind(Vdata$dummy, Vdata$VGK_vol)
colnames(y)[1:2] <- c("dummy", "vol")
est.VAR <- VAR(y,p=6)
mod_vol <- est.VAR$varresult$vol
texreg(mod_vol, digits = 6)
```

```{r B mat, warning=FALSE, message=FALSE}
Omega <- var(residuals(est.VAR))

#make the B matrix
loss <- function(param){
  #Define the restriction
  B <- matrix(c(param[1], param[2], 0, param[3]), ncol = 2)
  
  #Make BB' approximatively equal to omega
  X <- Omega - B %*% t(B)
  
  #loss function
  loss <- sum(X^2)
  return(loss)
}

res.opt <- optim(c(1, 0, 1), loss, method = "BFGS")
B.hat <- matrix(c(res.opt$par[1], res.opt$par[2], 0, res.opt$par[3]), ncol = 2)

print(cbind(Omega,B.hat %*% t(B.hat)))
```


```{r IRF tariff, warning=FALSE, message=FALSE}

#irf creation
irf_res <- irf(est.VAR, impulse = "dummy", response = "vol", 
                  bmat=b.hat, n.ahead = 7 * 7, boot = TRUE, ci = 0.95)

#function to extract relevant objects for plotting
single_varirf <- extract_varirf(irf_res)

#the plot
single_varirf %>% 
  ggplot(aes(x=period, y=irf_dummy_vol, ymin=lower_dummy_vol, ymax=upper_dummy_vol)) +
  geom_hline(yintercept = 0, color="red") +
  geom_ribbon(fill="grey", alpha=0.2) +
  geom_line() +
  theme_light() +
  ggtitle("IRF Dummy on Volatility")+
  ylab("")+
  xlab("") +
  theme_minimal()

```

```{r granger, warning=FALSE, message=FALSE}

#does volatility Granger cause dummy mentions
grangertest(y[,c("vol","dummy")], order = 6)

#does dummy mentions Granger cause volatility
grangertest(y[,c("dummy", "vol")], order = 6)

```





## Number of Post

```{r Estime N, warning=FALSE, message=FALSE, results="asis"}
y2 = cbind(Vdata$N , Vdata$VGK_vol)
colnames(y2)[1:2] <- c("N", "vol")
est.VAR2 <- VAR(y2,p=6)
mod_vol2 <- est.VAR2$varresult$vol
texreg(mod_vol2, digits = 6)
```




```{r B mat2, warning=FALSE, message=FALSE}
Omega2 <- var(residuals(est.VAR2))

#make the B matrix
loss2 <- function(param2){
  #Define the restriction
  B2 <- matrix(c(param2[1], param2[2], 0, param2[3]), ncol = 2)
  
  #Make BB' approximatively equal to omega
  X2 <- Omega2 - B2 %*% t(B2)
  
  #loss function
  loss2 <- sum(X2^2)
  return(loss2)
}

res.opt2 <- optim(c(1, 0, 1), loss2, method = "BFGS")
B.hat2 <- matrix(c(res.opt2$par[1], res.opt2$par[2], 0, res.opt2$par[3]), ncol = 2)

print(cbind(Omega2,B.hat2 %*% t(B.hat2)))
```


```{r IRF N , warning=FALSE, message=FALSE}

#irf creation
irf_res2 <- irf(est.VAR2, impulse = "N", response = "vol", 
                  bmat=b.hat2, n.ahead = 7 * 7, boot = TRUE, ci = 0.95)

#function to extract relevant objects for plotting
single_varirf2 <- extract_varirf(irf_res2)

#the plot
single_varirf2 %>% 
  ggplot(aes(x=period, y=irf_n_vol, ymin=lower_n_vol, ymax=upper_n_vol)) +
  geom_hline(yintercept = 0, color="red") +
  geom_ribbon(fill="grey", alpha=0.2) +
  geom_line() +
  theme_light() +
  ggtitle("IRF Number of Posts on Volatility")+
  ylab("")+
  xlab("") +
  theme_minimal()

```

```{r granger2, message=FALSE, warning=FALSE}

#does volatility Granger cause N mentions
grangertest(y2[,c("vol","N")], order = 6)

#does N mentions Granger cause volatility
grangertest(y2[,c("N", "vol")], order = 6)

```



## Tariff

```{r Estime tariff, warning=FALSE, message=FALSE, results="asis"}
y3 = cbind(Vdata$tariff , Vdata$VGK_vol)
colnames(y3)[1:2] <- c("tariff", "vol")
est.VAR3 <- VAR(y3,p=6)
mod_vol3 <- est.VAR3$varresult$vol
texreg(mod_vol3, digits = 6)
```




```{r B mat3, warning=FALSE, message=FALSE}
Omega3 <- var(residuals(est.VAR3))

#make the B matrix
loss3 <- function(param3){
  #Define the restriction
  B3 <- matrix(c(param3[1], param3[2], 0, param3[3]), ncol = 2)
  
  #Make BB' approximatively equal to omega
  X3 <- Omega3 - B3 %*% t(B3)
  
  #loss function
  loss3 <- sum(X3^2)
  return(loss3)
}

res.opt3 <- optim(c(1, 0, 1), loss3, method = "BFGS")
B.hat3 <- matrix(c(res.opt3$par[1], res.opt3$par[2], 0, res.opt3$par[3]), ncol = 2)

print(cbind(Omega3,B.hat3 %*% t(B.hat3)))
```


```{r IRF tariff , warning=FALSE, message=FALSE}

#irf creation
irf_res3 <- irf(est.VAR3, impulse = "tariff", response = "vol", 
                  bmat=b.hat3, n.ahead = 7 * 7, boot = TRUE, ci = 0.95)

#function to extract relevant objects for plotting
single_varirf3 <- extract_varirf(irf_res3)

#the plot
single_varirf3 %>% 
  ggplot(aes(x=period, y=irf_tariff_vol, ymin=lower_tariff_vol, ymax=upper_tariff_vol)) +
  geom_hline(yintercept = 0, color="red") +
  geom_ribbon(fill="grey", alpha=0.2) +
  geom_line() +
  theme_light() +
  ggtitle("IRF Tariff on Volatility")+
  ylab("")+
  xlab("") +
  theme_minimal()

```

```{r granger3, warning=FALSE, message=FALSE}

#does volatility Granger cause tariff mentions
grangertest(y3[,c("vol","tariff")], order = 6)

#does tariff mentions Granger cause volatility
grangertest(y3[,c("tariff", "vol")], order = 6)

```


## Trade

```{r Estime trade, warning=FALSE, message=FALSE, results="asis"}
y4 = cbind(Vdata$trade , Vdata$VGK_vol)
colnames(y4)[1:2] <- c("trade", "vol")
est.VAR4 <- VAR(y4,p=6)
mod_vol4 <- est.VAR4$varresult$vol
texreg(mod_vol4, digits = 6)
```




```{r B mat4, warning=FALSE, message=FALSE}
Omega4 <- var(residuals(est.VAR4))

#make the B matrix
loss4 <- function(param4){
  #Define the restriction
  B4 <- matrix(c(param4[1], param4[2], 0, param4[3]), ncol = 2)
  
  #Make BB' approximatively equal to omega
  X4 <- Omega4 - B4 %*% t(B4)
  
  #loss function
  loss4 <- sum(X4^2)
  return(loss4)
}

res.opt4 <- optim(c(1, 0, 1), loss4, method = "BFGS")
B.hat4 <- matrix(c(res.opt4$par[1], res.opt4$par[2], 0, res.opt4$par[3]), ncol = 2)

print(cbind(Omega4,B.hat4 %*% t(B.hat4)))
```


```{r IRF trade, warning=FALSE, message=FALSE}

#irf creation
irf_res4 <- irf(est.VAR4, impulse = "trade", response = "vol", 
                  bmat=b.hat4, n.ahead = 7 * 7, boot = TRUE, ci = 0.95)

#function to extract relevant objects for plotting
single_varirf4 <- extract_varirf(irf_res4)

#the plot
single_varirf4 %>% 
  ggplot(aes(x=period, y=irf_trade_vol, ymin=lower_trade_vol, ymax=upper_trade_vol)) +
  geom_hline(yintercept = 0, color="red") +
  geom_ribbon(fill="grey", alpha=0.2) +
  geom_line() +
  theme_light() +
  ggtitle("IRF Trade on Volatility")+
  ylab("")+
  xlab("") +
  theme_minimal()

```

```{r granger4, warning=FALSE, message=FALSE}

#does volatility Granger cause trade mentions
grangertest(y4[,c("vol","trade")], order = 6)

#does trade mentions Granger cause volatility
grangertest(y4[,c("trade", "vol")], order = 6)

```


# China

```{r Estime china, warning=FALSE, message=FALSE, results="asis"}
y5 = cbind(Vdata$china , Vdata$VGK_vol)
colnames(y5)[1:2] <- c("china", "vol")
est.VAR5 <- VAR(y5,p=6)
mod_vol5 <- est.VAR5$varresult$vol
texreg(mod_vol5, digits = 6)
```




```{r B mat5, warning=FALSE, message=FALSE}
Omega5 <- var(residuals(est.VAR5))

#make the B matrix
loss5 <- function(param5){
  #Define the restriction
  B5 <- matrix(c(param5[1], param5[2], 0, param5[3]), ncol = 2)
  
  #Make BB' approximatively equal to omega
  X5 <- Omega5 - B5 %*% t(B5)
  
  #loss function
  loss5 <- sum(X5^2)
  return(loss5)
}

res.opt5 <- optim(c(1, 0, 1), loss5, method = "BFGS")
B.hat5 <- matrix(c(res.opt5$par[1], res.opt5$par[2], 0, res.opt5$par[3]), ncol = 2)

print(cbind(Omega5,B.hat5 %*% t(B.hat5)))
```


```{r IRF china , warning=FALSE, message=FALSE}

#irf creation
irf_res5 <- irf(est.VAR5, impulse = "china", response = "vol", 
                  bmat=b.hat5, n.ahead = 7 * 7, boot = TRUE, ci = 0.95)

#function to extract relevant objects for plotting
single_varirf5 <- extract_varirf(irf_res5)

#the plot
single_varirf5 %>% 
  ggplot(aes(x=period, y=irf_china_vol, ymin=lower_china_vol, ymax=upper_china_vol)) +
  geom_hline(yintercept = 0, color="red") +
  geom_ribbon(fill="grey", alpha=0.2) +
  geom_line() +
  theme_light() +
  ggtitle("IRF China on Volatility")+
  ylab("")+
  xlab("") +
  theme_minimal()

```

```{r granger5, warning=FALSE, message=FALSE}

#does volatility Granger cause china mentions
grangertest(y5[,c("vol","china")], order = 6)

#does china mentions Granger cause volatility
grangertest(y5[,c("china", "vol")], order = 6)

```



# Interaction number of post and tariff

here is an example of our interaction 

```{r estime Interaction, warning=FALSE, message=FALSE, results="asis"}

#interaction
##N and tariff, 2 variables

int1 = Vdata$tariff * Vdata$N

y12 = cbind(int1, Vdata$VGK_vol)
colnames(y12)[1:2] <- c("interaction", "vol")
est.VAR12 <- VAR(y12,p=6)
mod_vol12 <- est.VAR12$varresult$vol
texreg(mod_vol12, digits = 6)

```


```{r B mat12, warning=FALSE, message=FALSE}
Omega12 <- var(residuals(est.VAR12))
#make the B matrix
loss12 <- function(param12){
  #Define the restriction
  B12 <- matrix(c(param12[1], param12[2], 0, param12[3]), ncol = 2)
  
  #Make BB' approximatively equal to omega
  X12 <- Omega12 - B12 %*% t(B12)
  
  #loss function
  loss12 <- sum(X12^2)
  return(loss12)
}

res.opt12 <- optim(c(1, 0, 1), loss12, method = "BFGS")
B.hat12 <- matrix(c(res.opt12$par[1], res.opt12$par[2], 0, res.opt12$par[3]), ncol = 2)

print(cbind(Omega12,B.hat12 %*% t(B.hat12)))
```

```{r IRF Int, warning=FALSE, message=FALSE}

#irf creation
irf_res12 <- irf(est.VAR12, impulse = "interaction", response = "vol", 
                  bmat=b.hat12, n.ahead = 7 * 7, boot = TRUE, ci = 0.95)

#function to extract relevant objects for plotting
single_varirf12 <- extract_varirf(irf_res12)

#the plot
single_varirf12 %>% 
  ggplot(aes(x=period, y=irf_interaction_vol, ymin=lower_interaction_vol, ymax=upper_interaction_vol)) +
  geom_hline(yintercept = 0, color="red") +
  geom_ribbon(fill="grey", alpha=0.2) +
  geom_line() +
  theme_light() +
  ggtitle("IRF Interaction on Volatility")+
  ylab("")+
  xlab("") +
  theme_minimal()

```


# Terms

Here we look for the first and second mandate effect of posts. We will use the tariff variable as a proxy for the posts

## First mandate

```{r datasetup2, results=FALSE, warning=FALSE, message=FALSE}

# First and Second Mandate

#first term
Vdata_f = filter(data,between(timestamp, as.Date('2017-01-20'), as.Date('2021-01-20')))

#second term
Vdata_s = filter(data,between(timestamp, as.Date('2025-01-20'), as.Date('2025-05-07')))
```


```{r estime first mandate, warning=FALSE, message=FALSE, results="asis"}

y_f_d = cbind(Vdata_f$tariff, Vdata_f$VGK_vol)
colnames(y_f_d)[1:2] <- c("tariff", "vol")
est.VAR_f_d <- VAR(y_f_d,p=6)
mod_vol_f_d <- est.VAR_f_d$varresult$vol
texreg(mod_vol_f_d, digits = 6)
```


```{r B mat first mandate, warning=FALSE, message=FALSE}
Omega_f_d <- var(residuals(est.VAR_f_d))
#make the B matrix
loss_f_d <- function(param_f_d){
  #Define the restriction
  B_f_d <- matrix(c(param_f_d[1], param_f_d[2], 0, param_f_d[3]), ncol = 2)
  
  #Make BB' approximatively equal to omega
  X_f_d <- Omega_f_d - B_f_d %*% t(B_f_d)
  
  #loss function
  loss_f_d <- sum(X_f_d^2)
  return(loss_f_d)
}

res.opt_f_d <- optim(c(1, 0, 1), loss_f_d, method = "BFGS")
B.hat_f_d <- matrix(c(res.opt_f_d$par[1], res.opt_f_d$par[2], 0, res.opt_f_d$par[3]), ncol = 2)

print(cbind(Omega_f_d,B.hat_f_d %*% t(B.hat_f_d)))
```

```{r IRF first, warning=FALSE, message=FALSE}

#irf creation
irf_res_f_d <- irf(est.VAR_f_d, impulse = "tariff", response = "vol", 
                  bmat=b.hat_f_d, n.ahead = 7 * 7, boot = TRUE, ci = 0.95)

#function to extract relevant objects for plotting
single_varirf_f_d <- extract_varirf(irf_res_f_d)

#the plot
single_varirf_f_d %>% 
  ggplot(aes(x=period, y=irf_tariff_vol, ymin=lower_tariff_vol, ymax=upper_tariff_vol)) +
  geom_hline(yintercept = 0, color="red") +
  geom_ribbon(fill="grey", alpha=0.2) +
  geom_line() +
  theme_light() +
  ggtitle("IRF First Mandate tariff on Volatility")+
  ylab("")+
  xlab("") +
  theme_minimal()


```

```{r granger_f_d, warning=FALSE, message=FALSE}

#does vol granger cause tarif
grangertest(y_f_d[,c("vol","tariff")], order = 6)

#does tarif granger cause vol
grangertest(y_f_d[,c("tariff", "vol")], order = 6)
```



## second mandate

```{r estime second mandate, warning=FALSE, message=FALSE, results="asis"}

y_s_d = cbind(Vdata_s$tariff, Vdata_s$VGK_vol)
colnames(y_s_d)[1:2] <- c("tariff", "vol")
est.VAR_s_d <- VAR(y_s_d,p=6)
mod_vol_s_d <- est.VAR_s_d$varresult$vol
texreg(mod_vol_s_d, digits = 6)
```


```{r B mat second mandate}
Omega_s_d <- var(residuals(est.VAR_s_d))
#make the B matrix
loss_s_d <- function(param_s_d){
  #Define the restriction
  B_s_d <- matrix(c(param_s_d[1], param_s_d[2], 0, param_s_d[3]), ncol = 2)
  
  #Make BB' approximatively equal to omega
  X_s_d <- Omega_s_d - B_s_d %*% t(B_s_d)
  
  #loss function
  loss_s_d <- sum(X_s_d^2)
  return(loss_s_d)
}

res.opt_s_d <- optim(c(1, 0, 1), loss_s_d, method = "BFGS")
B.hat_s_d <- matrix(c(res.opt_s_d$par[1], res.opt_s_d$par[2], 0, res.opt_s_d$par[3]), ncol = 2)

print(cbind(Omega_s_d,B.hat_s_d %*% t(B.hat_s_d)))
```

```{r IRF second, warning=FALSE, message=FALSE}

#irf creation
irf_res_s_d <- irf(est.VAR_s_d, impulse = "tariff", response = "vol", 
                  bmat=b.hat_s_d, n.ahead = 7 * 7, boot = TRUE, ci = 0.95)

#function to extract relevant objects for plotting
single_varirf_s_d <- extract_varirf(irf_res_s_d)

#the plot
single_varirf_s_d %>% 
  ggplot(aes(x=period, y=irf_tariff_vol, ymin=lower_tariff_vol, ymax=upper_tariff_vol)) +
  geom_hline(yintercept = 0, color="red") +
  geom_ribbon(fill="grey", alpha=0.2) +
  geom_line() +
  theme_light() +
  ggtitle("IRF Second Mandate tariff on Volatility")+
  ylab("")+
  xlab("") +
  theme_minimal()


```

```{r granger_s_d, warning=FALSE, message=FALSE}

#does vol granger cause tariff
grangertest(y_s_d[,c("vol","tariff")], order = 6)

#does tariff granger cause vol
grangertest(y_s_d[,c("tariff", "vol")], order = 6)
```