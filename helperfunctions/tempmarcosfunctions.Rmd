---
title: "temp marcos functions"
output:
  pdf_document: 
    toc: true
    fig_caption: yes
header-includes:
  - \usepackage{amsmath}
---
\newpage

```{r library_setup, results=FALSE, warning=FALSE, message=FALSE, echo=FALSE}
rm(list=ls())
require(tinytex) #LaTeX
require(ggplot2) #plots
require(AEC) #JP-Renne functions
require(expm) #matrix exponents
require(here) #directory finder
require(stringr) # analysis of strings, important for the detection in tweets
require(dplyr) #data management
require(lubridate) #data dates management
require(zoo) #for lagging
require(jtools) #tables
require(lmtest) #reg tests

getwd()
#setwd("...") -> set wd at base repo folder
```

# Data 

## Raw Data
```{r rawdata_setup, results=FALSE, warning=FALSE, message=FALSE}

#political shocks
raw_truths <- read.csv(here("data/political_data", "trump_all_truths.csv"))
raw_tweets <- read.csv(here("data/political_data", "tweets.csv"))


#market prices
raw_ONEQ <- read.csv(here("data/market_data", "ONEQ.csv"))
raw_SMI <- read.csv(here("data/market_data", "SMI.csv"))
raw_SPY <- read.csv(here("data/market_data", "SPY.csv")) 
raw_VTHR <- read.csv(here("data/market_data", "VTHR.csv"))
raw_VTI <- read.csv(here("data/market_data", "VTI.csv"))
raw_VGK <- read.csv(here("data/market_data", "VGK.csv"))
raw_DAX <- read.csv(here("data/market_data", "DAX.csv"))
raw_ASHR <- read.csv(here("data/market_data", "ASHR.csv"))

raw_SPYy <- read.csv(here("data/market_data", "Spyqyahoo.csv")) #yahoo

```


```{r data loop}
data_loop = function(year,symbol){ #symbol must be a string
  year = paste(year)
  months = c("01","02","03","04","05","06","07","08","09","10","11","12")
  for (t in 1:length(months)) {
    date = paste(year, months[t], sep="-")
    data = av_get(symbol, av_fun="TIME_SERIES_INTRADAY",interval="1min",
                  adjusted="false", extended_hours="false",
                  month=date, outputsize="full")
filename = paste(symbol,date,sep="-")
filename = paste("~/", filename, sep="")
filename = paste(filename,".csv",sep="")
write.csv(data,filename)
}}
```

```{r day_selector}
day_selector <- function(rawdata,year,month,day){
     date = paste("^",year,"-",sprintf("%02d",month),"-",sprintf("%02d",day),sep="")
     newdata = filter(rawdata, str_detect(timestamp, date))
     newdata$timestamp = as.POSIXct(newdata$timestamp, 
                                    format = "%Y-%m-%d %H:%M:%S", tz = "EST")
     return(newdata)
}

#day_ONEQ_0409 = day_selector(raw_ONEQ,2025,04,09) #usage
```

```{r plotter}

day_plotter = function(data,title){
  ggplot(data, aes(x = timestamp, y = close)) +
  geom_point(color = "blue", size = 0.01) +
  geom_line(aes(group=1)) +
  labs(title = title,
       x = "Time",
       y = "Close Price") +
   scale_x_datetime(date_labels = "%H:%M",  
                    date_breaks = "60 min") +
   theme_minimal() +
   theme(axis.text.x = element_text(angle = 45, hjust = 1))
}

#day_plotter(day_ONEQ_0409,"ONEQ Price on April 9th") #usage
```


```{r quick time series analysis}

quick_arma = function(daydata,p,d,q){ #p,d,q as in arima
  acf(daydata$close)
  pacf(daydata$close)
  names = c(paste("AR",p,sep="-"),paste("AR",(p+1),sep="-"),paste("AR",(p+2),sep="-"))

  AR1 = arima(daydata$close,c(p,d,q),method="ML")
  AR2 = arima(daydata$close,c((p+1),d,q),method="ML")
  AR3 = arima(daydata$close,c((p+2),d,q),method="ML")
  table1 = export_summs(AR1,AR2,AR3, model.names = names, digits = 4)
  huxtable::caption(table1) <- "AR Estimations"
  huxtable::set_width(table1, 0.8)

  names2 = paste(names,"Residuals")
  AR1res = as.numeric(AR1$residuals)
  REG1res_lagged <- lag(AR1res, 1)
  iidcheck1 = lm(AR1res ~ REG1res_lagged)
  AR2res = as.numeric(AR2$residuals)
  REG2res_lagged <- lag(AR2res, 1)
  iidcheck2 = lm(AR2res ~ REG2res_lagged)
  AR3res = as.numeric(AR3$residuals)
  REG3res_lagged <- lag(AR3res, 1)
  iidcheck3 = lm(AR3res ~ REG3res_lagged)
  table2 = export_summs(iidcheck1,iidcheck2,iidcheck3, 
                        model.names = names2, digits = 4)
  huxtable::caption(table2) <- "Checking Residuals"
  huxtable::set_width(table2, 0.8)

  return(list(table1,table2))

}


#quick_arma(day_ONEQ_0409,2,0,0) #usage
```









